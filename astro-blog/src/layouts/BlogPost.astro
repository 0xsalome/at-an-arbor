---
import { marked } from 'marked';
import DOMPurify from 'isomorphic-dompurify';
import ThemeToggle from '../components/ThemeToggle.astro';
import { convertWikiLinksInHTML } from '../utils/wikilinks';
import type { Backlink } from '../utils/backlinks';
import '../styles/global.css';

interface Version {
  date: string;
  summary?: string;
  content: string;
}

interface Props {
  title: string;
  date: string;
  updated: string;
  tags?: string[];
  backlinks: Backlink[];
  versions?: Version[];
  latestLog?: string;
  noindex?: boolean;
}

const { title, date, updated, tags = ['blog'], backlinks, latestLog, noindex } = Astro.props;
const postLabel = tags.includes('essay') ? 'ESSAY' : 'BLOG';
const siteUrl = 'https://0xsalome.github.io/at-an-arbor';
const ogImageUrl = `${siteUrl}/images/ogp.png`;
const renderedSlotHtml = await Astro.slots.render('default');
const normalizedSlotHtml = convertWikiLinksInHTML(renderedSlotHtml);
---

<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{title} - at an arbor</title>
    <meta name="description" content={title} />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={title} />
    <meta property="og:type" content="article" />
    <meta property="og:url" content={`${siteUrl}/blog/${Astro.params.slug}`} />
    <meta property="og:image" content={ogImageUrl} />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={title} />
    <meta name="twitter:image" content={ogImageUrl} />
    {noindex && <meta name="robots" content="noindex, nofollow" />}
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Shippori+Mincho:wght@400;700&family=Noto+Serif+JP:wght@400;700&family=JetBrains+Mono&display=swap" rel="stylesheet">
    <script is:inline>
      (function() {
        const isDark = localStorage.getItem('darkMode') === 'true';
        if (isDark) document.documentElement.classList.add('dark');
      })();
    </script>
    <style>
      /* Prose„Çπ„Çø„Ç§„É´ÔºàTailwind Typography‰∫íÊèõÔºâ */
      .prose {
        color: #374151;
        max-width: 65ch;
      }
      .prose :where(p):not(:where([class~="not-prose"] *)) {
        margin-top: 1.25em;
        margin-bottom: 1.25em;
      }
      .prose :where(a):not(:where([class~="not-prose"] *)) {
        color: #2563eb;
        text-decoration: underline;
        font-weight: 500;
      }
      .prose :where(strong):not(:where([class~="not-prose"] *)) {
        color: #111827;
        font-weight: 600;
      }
      .prose :where(h1):not(:where([class~="not-prose"] *)) {
        color: #111827;
        font-weight: 800;
        font-size: 2.25em;
        margin-top: 0;
        margin-bottom: 0.8888889em;
        line-height: 1.1111111;
      }
      .prose :where(h2):not(:where([class~="not-prose"] *)) {
        color: #111827;
        font-weight: 700;
        font-size: 1.5em;
        margin-top: 2em;
        margin-bottom: 1em;
        line-height: 1.3333333;
      }
      .prose :where(h3):not(:where([class~="not-prose"] *)) {
        color: #111827;
        font-weight: 600;
        font-size: 1.25em;
        margin-top: 1.6em;
        margin-bottom: 0.6em;
        line-height: 1.6;
      }
      .prose :where(ul):not(:where([class~="not-prose"] *)) {
        list-style-type: disc;
        margin-top: 1.25em;
        margin-bottom: 1.25em;
        padding-left: 1.625em;
      }
      .prose :where(ol):not(:where([class~="not-prose"] *)) {
        list-style-type: decimal;
        margin-top: 1.25em;
        margin-bottom: 1.25em;
        padding-left: 1.625em;
      }
      .prose :where(li):not(:where([class~="not-prose"] *)) {
        margin-top: 0.5em;
        margin-bottom: 0.5em;
      }
      .prose :where(code):not(:where([class~="not-prose"] *)) {
        color: #111827;
        font-weight: 600;
        font-size: 0.875em;
      }
      .prose :where(pre):not(:where([class~="not-prose"] *)) {
        color: #e5e7eb;
        background-color: #1f2937;
        overflow-x: auto;
        font-weight: 400;
        font-size: 0.875em;
        line-height: 1.7142857;
        margin-top: 1.7142857em;
        margin-bottom: 1.7142857em;
        border-radius: 0.375rem;
        padding: 0.8571429em 1.1428571em;
      }
      :global(.dark) .prose {
        color: #d1d5db;
      }
      :global(.dark) .prose :where(a):not(:where([class~="not-prose"] *)) {
        color: #60a5fa;
      }
      :global(.dark) .prose :where(strong):not(:where([class~="not-prose"] *)) {
        color: #f9fafb;
      }
      :global(.dark) .prose :where(h1):not(:where([class~="not-prose"] *)),
      :global(.dark) .prose :where(h2):not(:where([class~="not-prose"] *)),
      :global(.dark) .prose :where(h3):not(:where([class~="not-prose"] *)) {
        color: #f9fafb;
      }
    </style>
  </head>
  <body class="min-h-screen bg-paper-white dark:bg-ink-black text-text-main dark:text-text-inv transition-colors">
    <div class="flex flex-col md:flex-row">
      <!-- Sidebar -->
      <aside class="w-full md:w-1/6 p-6 md:p-12 border-b md:border-b-0 md:border-r border-gray-200 dark:border-gray-700">
        <nav class="space-y-6">
          <a href="/at-an-arbor/" class="block text-sm font-mono text-purple-600 dark:text-purple-300 hover:text-purple-700 dark:hover:text-purple-200 transition-colors">‚Üê HOME</a>
          <div class="text-xs font-mono text-gray-500 dark:text-gray-400">
            at an arbor
          </div>
          <ThemeToggle />
        </nav>
      </aside>

      <!-- Main content -->
      <main class="w-full md:w-5/6 p-6 md:p-16 lg:p-24 max-w-4xl mx-auto">
        <header class="mb-12 border-b border-gray-900 dark:border-gray-600 pb-8">
          <div class="font-mono text-sm text-gray-500 dark:text-gray-400 mb-4" data-astro-cid-bvzihdzo>
            {updated.slice(0, 10)}
            {updated > date && <span> (Published: {date.slice(0, 10)})</span>}
            <span class="mx-2" data-astro-cid-bvzihdzo>/</span>
            {postLabel}
            {updated > date && <span> / ·öõ Regrown</span>}
          </div>
          <h1 class="text-3xl md:text-5xl font-serif font-bold leading-tight">{title}</h1>
        </header>

        {/* Change Log Section */}
        {updated > date && (
          <details class="group mb-12 font-mono text-sm bg-gray-50 dark:bg-gray-800 p-6 rounded-sm border-l-2 border-gray-300 dark:border-gray-600">
            <summary class="list-none cursor-pointer font-bold mb-4 text-gray-500 dark:text-gray-400 select-none">
              ·öõ Log <span class="font-normal text-xs opacity-80">(hover / click„ÅßÂ±ïÈñã)</span>
            </summary>
            <ul
              id="change-log-list"
              class="flex flex-col text-gray-700 dark:text-gray-300 max-h-[4.5rem] overflow-hidden pr-2 transition-[max-height] duration-300 group-hover:max-h-80 group-hover:overflow-y-auto group-open:max-h-80 group-open:overflow-y-auto custom-scrollbar"
            >
              <li class="grid grid-cols-[max-content_1fr] gap-4 py-1" data-log-kind="latest">
                <a href={`#version-${updated.slice(0, 10)}`} class="text-gray-500 dark:text-gray-400 hover:underline">
                  {updated.slice(0, 10)}:
                </a>
                <span class="log-label">{latestLog || 'ÊúÄÊñ∞„ÅÆÊõ¥Êñ∞'}</span>
              </li>
              <li class="grid grid-cols-[max-content_1fr] gap-4 py-1" data-log-kind="original">
                <a href="#version-original" class="text-gray-500 dark:text-gray-400 hover:underline">
                  {date.slice(0, 10)}:
                </a>
                <span>„ÅØ„Åò„ÇÅ„ÅÆÊäïÁ®ø</span>
              </li>
            </ul>
          </details>
        )}

        {/* Content Flow: Latest to Oldest */}
        <div class="space-y-16">
          {/* Latest Version */}
          <div id={`version-${updated.slice(0, 10)}`}>
            <article
              class="prose prose-stone dark:prose-invert prose-lg font-serif leading-loose"
              data-original-date={updated > date ? date : undefined}
              set:html={normalizedSlotHtml}
            />
          </div>

          {/* Past Versions (from frontmatter versions array) */}
          {Astro.props.versions && [...Astro.props.versions].sort((a, b) => b.date.localeCompare(a.date)).map((version: Version) => (
            <div class="version" id={`version-${version.date.slice(0, 10)}`}>
              <hr class="border-gray-300 dark:border-gray-700 mb-12" />
              <h3 class="font-mono text-gray-500 dark:text-gray-400 mb-8">
                {version.date.slice(0, 10)}
                {version.date === date && ' (Original)'}
              </h3>
              <div
                class="prose prose-stone dark:prose-invert prose-lg font-serif leading-loose"
                set:html={DOMPurify.sanitize(convertWikiLinksInHTML(marked(version.content)))}
              />
            </div>
          ))}
        </div>

        {/* Auto-insert original version marker at double <hr> (--- ---) */}
        {updated > date && (
          <script define:vars={{ originalDate: date.slice(0, 10), latestDate: updated.slice(0, 10) }}>
            document.addEventListener('DOMContentLoaded', () => {
              const article = document.querySelector('article[data-original-date]');
              if (!article) return;
              const logList = document.getElementById('change-log-list');

              const formatDate = (year, month, day) => {
                const m = String(Number(month)).padStart(2, '0');
                const d = String(Number(day)).padStart(2, '0');
                return `${year}-${m}-${d}`;
              };

              const parseDateString = (dateStr) => {
                const normalized = dateStr.replace(/\//g, '-');
                const parsed = new Date(`${normalized}T00:00:00`);
                return Number.isNaN(parsed.getTime()) ? null : parsed;
              };

              const resolveMonthDayDate = (month, day, upperBoundDate) => {
                const m = Number(month);
                const d = Number(day);
                if (!m || !d) return null;

                const bound = parseDateString(upperBoundDate);
                if (!bound) return null;

                const year = bound.getFullYear();
                const candidates = [
                  new Date(year, m - 1, d),
                  new Date(year - 1, m - 1, d),
                ];

                const valid = candidates.filter((candidate) => candidate <= bound);
                const picked = valid.length > 0
                  ? valid.sort((a, b) => b.getTime() - a.getTime())[0]
                  : candidates[0];

                return formatDate(picked.getFullYear(), picked.getMonth() + 1, picked.getDate());
              };

              const normalizeText = (value) => (
                value
                  .replace(/[Ôºê-Ôºô]/g, (char) => String.fromCharCode(char.charCodeAt(0) - 65248))
                  .replace(/[Ôºè]/g, '/')
                  .replace(/[Ôºé„ÄÇ]/g, '.')
                  .replace(/[ÔΩû„Äú]/g, '~')
              );

              const extractDateFromSectionText = (text, upperBoundDate) => {
                const normalized = normalizeText(text);

                const iso = normalized.match(/\b(20\d{2})[-/.](\d{1,2})[-/.](\d{1,2})\b/);
                if (iso) return formatDate(iso[1], iso[2], iso[3]);

                const ranges = normalized.match(/(\d{1,2})\s*[-/.]\s*(\d{1,2})\s*[~\-‚Äì]\s*(\d{1,2})\s*[-/.]\s*(\d{1,2})/);
                if (ranges) {
                  return resolveMonthDayDate(ranges[3], ranges[4], upperBoundDate);
                }

                const monthDays = normalized.match(/\b(\d{1,2})\s*[-/.]\s*(\d{1,2})\b/);
                if (monthDays) {
                  return resolveMonthDayDate(monthDays[1], monthDays[2], upperBoundDate);
                }

                return null;
              };

              const collectSectionText = (startNode, endNode) => {
                let text = '';
                let node = startNode;
                while (node && node !== endNode) {
                  if (node.tagName !== 'HR') {
                    text += ` ${node.textContent || ''}`;
                  }
                  node = node.nextElementSibling;
                }
                return text;
              };

              // Find all consecutive <hr> elements (double line = boundary)
              const hrs = Array.from(article.querySelectorAll('hr'));
              const boundaries = [];
              for (let i = 0; i < hrs.length - 1; i++) {
                const hr1 = hrs[i];
                const hr2 = hrs[i + 1];
                if (hr1.nextElementSibling === hr2) {
                  boundaries.push([hr1, hr2]);
                  i += 1;
                }
              }

              const totalPosts = boundaries.length + 1;
              if (logList) {
                const latestLabel = logList.querySelector('[data-log-kind="latest"] .log-label');
                if (latestLabel) {
                  latestLabel.textContent = `ÊúÄÊñ∞„ÅÆÊõ¥Êñ∞ÔºàÁ¨¨${totalPosts}ÂõûÔºâ`;
                }
              }

              if (boundaries.length === 0) {
                const originalLink = logList?.querySelector('[data-log-kind="original"] a');
                if (originalLink) {
                  originalLink.setAttribute('href', `#version-${latestDate}`);
                }
                return;
              }

              let upperBoundDate = latestDate;
              boundaries.forEach(([hr1, hr2], index) => {
                const nextBoundary = boundaries[index + 1];
                const sectionStart = hr2.nextElementSibling;
                const sectionEnd = nextBoundary ? nextBoundary[0] : null;
                const sectionText = collectSectionText(sectionStart, sectionEnd);
                hr2.remove();
                const postNumber = totalPosts - (index + 1);
                const isOriginal = index === boundaries.length - 1;
                const markerId = isOriginal ? 'version-original' : `version-update-${postNumber}`;

                const marker = document.createElement('div');
                marker.id = markerId;
                marker.className = 'original-version-marker mt-16 mb-8';
                marker.innerHTML = `
                  <div class="border-t-2 border-b-2 border-gray-400 dark:border-gray-500 py-4 my-8">
                    <p class="font-mono text-sm text-gray-500 dark:text-gray-400 text-center tracking-wider">
                      ${isOriginal ? `·öõ „ÅØ„Åò„ÇÅ„ÅÆÊäïÁ®ø / ${originalDate}` : `·öõ Á¨¨${postNumber}Âõû„ÅÆÊäïÁ®ø`}
                    </p>
                  </div>
                `;
                hr1.replaceWith(marker);

                if (!isOriginal && logList) {
                  const detectedDate = extractDateFromSectionText(sectionText, upperBoundDate);
                  if (detectedDate) upperBoundDate = detectedDate;
                  const row = document.createElement('li');
                  row.className = 'grid grid-cols-[max-content_1fr] gap-4 py-1';
                  row.setAttribute('data-log-kind', 'auto');
                  row.innerHTML = `
                    <a href="#${markerId}" class="text-gray-500 dark:text-gray-400 hover:underline">
                      ${detectedDate || `Á¨¨${postNumber}Âõû`}:
                    </a>
                    <span>Á¨¨${postNumber}Âõû</span>
                  `;

                  const originalRow = logList.querySelector('[data-log-kind="original"]');
                  if (originalRow) {
                    logList.insertBefore(row, originalRow);
                  } else {
                    logList.appendChild(row);
                  }
                }
              });
            });
          </script>
        )}

        {/* Obsidian-style callouts and highlights */}
        <script>
          document.addEventListener('DOMContentLoaded', () => {
            const articles = Array.from(document.querySelectorAll('article.prose'));
            if (articles.length === 0) return;

            // Fallback: convert Obsidian image wikilinks left in rendered HTML.
            const imageWikiRegex = /!\[\[(.*?)\]\]/g;
            articles.forEach((article) => {
              article.innerHTML = article.innerHTML.replace(imageWikiRegex, (_match, rawName) => {
                const imageName = (rawName || '').trim();
                const encodedName = encodeURIComponent(imageName);
                return `<img src="/at-an-arbor/images/blog/${encodedName}" alt="" loading="lazy" decoding="async">`;
              });
            });

            const article = articles[0];

            // Convert > [!type] to callout boxes
            const blockquotes = article.querySelectorAll('blockquote');
            blockquotes.forEach(bq => {
              const text = bq.innerHTML;
              const calloutMatch = text.match(/^\s*<p>\s*\[!(note|tip|warning|important|quote)\]\s*(.*?)<\/p>/i);
              if (calloutMatch) {
                const type = calloutMatch[1].toLowerCase();
                const title = calloutMatch[2] || type.charAt(0).toUpperCase() + type.slice(1);
                const content = text.replace(calloutMatch[0], '').trim();

                bq.className = `callout callout-${type}`;
                bq.innerHTML = `
                  <div class="callout-title">${title}</div>
                  <div class="callout-content">${content}</div>
                `;
              }
            });

            // Convert ==text== to <mark>text</mark>
            const walker = document.createTreeWalker(article, NodeFilter.SHOW_TEXT);
            const nodesToReplace = [];
            while (walker.nextNode()) {
              if (walker.currentNode.textContent.includes('==')) {
                nodesToReplace.push(walker.currentNode);
              }
            }
            nodesToReplace.forEach(node => {
              if (node.parentElement.tagName === 'CODE' || node.parentElement.tagName === 'PRE') return;
              const newHTML = node.textContent.replace(/==([^=]+)==/g, '<mark>$1</mark>');
              if (newHTML !== node.textContent) {
                const span = document.createElement('span');
                span.innerHTML = newHTML;
                node.parentNode.replaceChild(span, node);
              }
            });

            // Style task list items
            const listItems = article.querySelectorAll('li');
            listItems.forEach(li => {
              const checkbox = li.querySelector('input[type="checkbox"]');
              if (checkbox) {
                li.classList.add('task-list-item');
              }
            });
          });
        </script>

        {backlinks.length > 0 && (
          <section class="mt-12 pt-8 border-t border-gray-200 dark:border-gray-700">
            <h2 class="text-sm font-mono text-gray-500 dark:text-gray-400 mb-4 tracking-wider">
              üìé REFERENCED BY
            </h2>
            <ul class="space-y-3">
              {backlinks.map((link) => (
                <li>
                  <a
                    href={`/at-an-arbor/blog/${link.slug}`}
                    class="text-purple-600 dark:text-purple-300 hover:text-purple-700 dark:hover:text-purple-200 transition-colors font-serif text-lg"
                  >
                    {link.title}
                  </a>
                  <span class="text-sm text-gray-500 dark:text-gray-400 ml-2">({link.updated.slice(0, 10)})</span>
                </li>
              ))}
            </ul>
          </section>
        )}

        <footer class="mt-16 pt-8 border-t border-gray-200 dark:border-gray-700 flex justify-between font-mono text-sm">
          <a href="/at-an-arbor/blog/" class="text-purple-600 dark:text-purple-300 hover:text-purple-700 dark:hover:text-purple-200 transition-colors">‚Üê BACK</a>
          <span class="text-gray-500 dark:text-gray-400">END OF RECORD</span>
        </footer>
      </main>
    </div>
  </body>
</html>
