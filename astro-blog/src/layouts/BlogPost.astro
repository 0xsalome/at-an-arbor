---
import { marked } from 'marked';
import DOMPurify from 'isomorphic-dompurify';
import ThemeToggle from '../components/ThemeToggle.astro';
import { convertWikiLinksInHTML } from '../utils/wikilinks';
import type { Backlink } from '../utils/backlinks';
import '../styles/global.css';

interface Version {
  date: string;
  summary?: string;
  content: string;
}

interface Props {
  title: string;
  date: string;
  updated: string;
  backlinks: Backlink[];
  versions?: Version[];
  latestLog?: string;
}

const { title, date, updated, backlinks, latestLog } = Astro.props;
const siteUrl = 'https://0xsalome.github.io/at-an-arbor';
const ogImageUrl = `${siteUrl}/images/ogp.png`;
---

<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{title} - at an arbor</title>
    <meta name="description" content={title} />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={title} />
    <meta property="og:type" content="article" />
    <meta property="og:url" content={`${siteUrl}/blog/${Astro.params.slug}`} />
    <meta property="og:image" content={ogImageUrl} />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={title} />
    <meta name="twitter:image" content={ogImageUrl} />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Shippori+Mincho:wght@400;700&family=Noto+Serif+JP:wght@400;700&family=JetBrains+Mono&display=swap" rel="stylesheet">
    <script is:inline>
      (function() {
        const isDark = localStorage.getItem('darkMode') === 'true';
        if (isDark) document.documentElement.classList.add('dark');
      })();
    </script>
    <style>
      /* Prose„Çπ„Çø„Ç§„É´ÔºàTailwind Typography‰∫íÊèõÔºâ */
      .prose {
        color: #374151;
        max-width: 65ch;
      }
      .prose :where(p):not(:where([class~="not-prose"] *)) {
        margin-top: 1.25em;
        margin-bottom: 1.25em;
      }
      .prose :where(a):not(:where([class~="not-prose"] *)) {
        color: #2563eb;
        text-decoration: underline;
        font-weight: 500;
      }
      .prose :where(strong):not(:where([class~="not-prose"] *)) {
        color: #111827;
        font-weight: 600;
      }
      .prose :where(h1):not(:where([class~="not-prose"] *)) {
        color: #111827;
        font-weight: 800;
        font-size: 2.25em;
        margin-top: 0;
        margin-bottom: 0.8888889em;
        line-height: 1.1111111;
      }
      .prose :where(h2):not(:where([class~="not-prose"] *)) {
        color: #111827;
        font-weight: 700;
        font-size: 1.5em;
        margin-top: 2em;
        margin-bottom: 1em;
        line-height: 1.3333333;
      }
      .prose :where(h3):not(:where([class~="not-prose"] *)) {
        color: #111827;
        font-weight: 600;
        font-size: 1.25em;
        margin-top: 1.6em;
        margin-bottom: 0.6em;
        line-height: 1.6;
      }
      .prose :where(ul):not(:where([class~="not-prose"] *)) {
        list-style-type: disc;
        margin-top: 1.25em;
        margin-bottom: 1.25em;
        padding-left: 1.625em;
      }
      .prose :where(ol):not(:where([class~="not-prose"] *)) {
        list-style-type: decimal;
        margin-top: 1.25em;
        margin-bottom: 1.25em;
        padding-left: 1.625em;
      }
      .prose :where(li):not(:where([class~="not-prose"] *)) {
        margin-top: 0.5em;
        margin-bottom: 0.5em;
      }
      .prose :where(code):not(:where([class~="not-prose"] *)) {
        color: #111827;
        font-weight: 600;
        font-size: 0.875em;
      }
      .prose :where(pre):not(:where([class~="not-prose"] *)) {
        color: #e5e7eb;
        background-color: #1f2937;
        overflow-x: auto;
        font-weight: 400;
        font-size: 0.875em;
        line-height: 1.7142857;
        margin-top: 1.7142857em;
        margin-bottom: 1.7142857em;
        border-radius: 0.375rem;
        padding: 0.8571429em 1.1428571em;
      }
      :global(.dark) .prose {
        color: #d1d5db;
      }
      :global(.dark) .prose :where(a):not(:where([class~="not-prose"] *)) {
        color: #60a5fa;
      }
      :global(.dark) .prose :where(strong):not(:where([class~="not-prose"] *)) {
        color: #f9fafb;
      }
      :global(.dark) .prose :where(h1):not(:where([class~="not-prose"] *)),
      :global(.dark) .prose :where(h2):not(:where([class~="not-prose"] *)),
      :global(.dark) .prose :where(h3):not(:where([class~="not-prose"] *)) {
        color: #f9fafb;
      }
    </style>
  </head>
  <body class="min-h-screen bg-paper-white dark:bg-ink-black text-text-main dark:text-text-inv transition-colors">
    <div class="flex flex-col md:flex-row">
      <!-- Sidebar -->
      <aside class="w-full md:w-1/6 p-6 md:p-12 border-b md:border-b-0 md:border-r border-gray-200 dark:border-gray-700">
        <nav class="space-y-6">
          <a href="/at-an-arbor/" class="block text-sm font-mono text-purple-600 dark:text-purple-300 hover:text-purple-700 dark:hover:text-purple-200 transition-colors">‚Üê HOME</a>
          <div class="text-xs font-mono text-gray-500 dark:text-gray-400">
            at an arbor
          </div>
          <ThemeToggle />
        </nav>
      </aside>

      <!-- Main content -->
      <main class="w-full md:w-5/6 p-6 md:p-16 lg:p-24 max-w-4xl mx-auto">
        <header class="mb-12 border-b border-gray-900 dark:border-gray-600 pb-8">
          <div class="font-mono text-sm text-gray-500 dark:text-gray-400 mb-4" data-astro-cid-bvzihdzo>
            {updated.slice(0, 10)}
            {updated > date && <span> (Published: {date.slice(0, 10)})</span>}
            <span class="mx-2" data-astro-cid-bvzihdzo>/</span>
            BLOG
            {updated > date && <span> / ·öõ Regrown</span>}
          </div>
          <h1 class="text-3xl md:text-5xl font-serif font-bold leading-tight">{title}</h1>
        </header>

        {/* Change Log Section */}
        {updated > date && (
          <div class="mb-12 font-mono text-sm bg-gray-50 dark:bg-gray-800 p-6 rounded-sm border-l-2 border-gray-300 dark:border-gray-600">
            <h2 class="font-bold mb-4 text-gray-500 dark:text-gray-400">·öõ Log</h2>
            <ul class="flex flex-col text-gray-700 dark:text-gray-300 max-h-[7.5rem] overflow-y-auto pr-2 custom-scrollbar">
              {/* Latest Log */}
              {latestLog && (
                <li class="grid grid-cols-[max-content_1fr] gap-4 py-1">
                  <a href={`#version-${updated.slice(0, 10)}`} class="text-gray-500 dark:text-gray-400 hover:underline">
                    {updated.slice(0, 10)}:
                  </a>
                  <span>{latestLog}</span>
                </li>
              )}
              
              {/* Past Versions Logs */}
              {Astro.props.versions && [...Astro.props.versions].sort((a, b) => b.date.localeCompare(a.date)).map((version: Version) => (
                version.summary && (
                  <li class="grid grid-cols-[max-content_1fr] gap-4 py-1">
                    <a href={`#version-${version.date.slice(0, 10)}`} class="text-gray-500 dark:text-gray-400 hover:underline">
                      {version.date.slice(0, 10)}:
                    </a>
                    <span>{version.summary}</span>
                  </li>
                )
              ))}

              {/* Initial Commit */}
              <li class="grid grid-cols-[max-content_1fr] gap-4 py-1">
                <a href={`#version-${date.slice(0, 10)}`} class="text-gray-500 dark:text-gray-400 hover:underline">
                  {date.slice(0, 10)}:
                </a>
                <span>ÂàùÁâàÂÖ¨Èñã„ÄÇ</span>
              </li>
            </ul>
          </div>
        )}

        {/* Content Flow: Latest to Oldest */}
        <div class="space-y-16">
          {/* Latest Version */}
          <div id={`version-${updated.slice(0, 10)}`}>
            <article
              class="prose prose-stone dark:prose-invert prose-lg font-serif leading-loose"
              data-original-date={updated > date ? date : undefined}
            >
              <slot />
            </article>
          </div>

          {/* Past Versions (from frontmatter versions array) */}
          {Astro.props.versions && [...Astro.props.versions].sort((a, b) => b.date.localeCompare(a.date)).map((version: Version) => (
            <div class="version" id={`version-${version.date.slice(0, 10)}`}>
              <hr class="border-gray-300 dark:border-gray-700 mb-12" />
              <h3 class="font-mono text-gray-500 dark:text-gray-400 mb-8">
                {version.date.slice(0, 10)}
                {version.date === date && ' (Original)'}
              </h3>
              <div
                class="prose prose-stone dark:prose-invert prose-lg font-serif leading-loose"
                set:html={DOMPurify.sanitize(convertWikiLinksInHTML(marked(version.content)))}
              />
            </div>
          ))}
        </div>

        {/* Auto-insert original version marker at double <hr> (--- ---) */}
        {updated > date && (
          <script define:vars={{ originalDate: date.slice(0, 10) }}>
            document.addEventListener('DOMContentLoaded', () => {
              const article = document.querySelector('article[data-original-date]');
              if (!article) return;

              // Find consecutive <hr> elements (double line = boundary)
              const hrs = article.querySelectorAll('hr');
              let boundaryHr = null;

              for (let i = 0; i < hrs.length - 1; i++) {
                const hr1 = hrs[i];
                const hr2 = hrs[i + 1];
                // Check if hr2 is the immediate next sibling of hr1
                if (hr1.nextElementSibling === hr2) {
                  boundaryHr = hr1;
                  // Remove the second hr (we'll replace both with the marker)
                  hr2.remove();
                  break;
                }
              }

              if (!boundaryHr) return;

              // Create version marker
              const marker = document.createElement('div');
              marker.id = `version-${originalDate}`;
              marker.className = 'original-version-marker mt-16 mb-8';
              marker.innerHTML = `
                <div class="border-t-2 border-b-2 border-gray-400 dark:border-gray-500 py-4 my-8">
                  <p class="font-mono text-sm text-gray-500 dark:text-gray-400 text-center tracking-wider">
                    ·öõ ÂàùÁâà / ${originalDate}
                  </p>
                </div>
              `;

              // Replace the first <hr> with the marker
              boundaryHr.replaceWith(marker);
            });
          </script>
        )}

        {/* Obsidian-style callouts and highlights */}
        <script>
          document.addEventListener('DOMContentLoaded', () => {
            const article = document.querySelector('article.prose');
            if (!article) return;

            // Convert > [!type] to callout boxes
            const blockquotes = article.querySelectorAll('blockquote');
            blockquotes.forEach(bq => {
              const text = bq.innerHTML;
              const calloutMatch = text.match(/^\s*<p>\s*\[!(note|tip|warning|important|quote)\]\s*(.*?)<\/p>/i);
              if (calloutMatch) {
                const type = calloutMatch[1].toLowerCase();
                const title = calloutMatch[2] || type.charAt(0).toUpperCase() + type.slice(1);
                const content = text.replace(calloutMatch[0], '').trim();

                bq.className = `callout callout-${type}`;
                bq.innerHTML = `
                  <div class="callout-title">${title}</div>
                  <div class="callout-content">${content}</div>
                `;
              }
            });

            // Convert ==text== to <mark>text</mark>
            const walker = document.createTreeWalker(article, NodeFilter.SHOW_TEXT);
            const nodesToReplace = [];
            while (walker.nextNode()) {
              if (walker.currentNode.textContent.includes('==')) {
                nodesToReplace.push(walker.currentNode);
              }
            }
            nodesToReplace.forEach(node => {
              if (node.parentElement.tagName === 'CODE' || node.parentElement.tagName === 'PRE') return;
              const newHTML = node.textContent.replace(/==([^=]+)==/g, '<mark>$1</mark>');
              if (newHTML !== node.textContent) {
                const span = document.createElement('span');
                span.innerHTML = newHTML;
                node.parentNode.replaceChild(span, node);
              }
            });

            // Style task list items
            const listItems = article.querySelectorAll('li');
            listItems.forEach(li => {
              const checkbox = li.querySelector('input[type="checkbox"]');
              if (checkbox) {
                li.classList.add('task-list-item');
              }
            });
          });
        </script>

        {backlinks.length > 0 && (
          <section class="mt-12 pt-8 border-t border-gray-200 dark:border-gray-700">
            <h2 class="text-sm font-mono text-gray-500 dark:text-gray-400 mb-4 tracking-wider">
              üìé REFERENCED BY
            </h2>
            <ul class="space-y-3">
              {backlinks.map((link) => (
                <li>
                  <a
                    href={`/at-an-arbor/blog/${link.slug}`}
                    class="text-purple-600 dark:text-purple-300 hover:text-purple-700 dark:hover:text-purple-200 transition-colors font-serif text-lg"
                  >
                    {link.title}
                  </a>
                  <span class="text-sm text-gray-500 dark:text-gray-400 ml-2">({link.updated.slice(0, 10)})</span>
                </li>
              ))}
            </ul>
          </section>
        )}

        <footer class="mt-16 pt-8 border-t border-gray-200 dark:border-gray-700 flex justify-between font-mono text-sm">
          <a href="/at-an-arbor/blog/" class="text-purple-600 dark:text-purple-300 hover:text-purple-700 dark:hover:text-purple-200 transition-colors">‚Üê BACK</a>
          <span class="text-gray-500 dark:text-gray-400">END OF RECORD</span>
        </footer>
      </main>
    </div>
  </body>
</html>
