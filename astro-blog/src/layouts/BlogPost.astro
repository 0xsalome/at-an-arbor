---
import { marked } from 'marked';
import type { Backlink } from '../utils/backlinks';
import '../styles/global.css';

interface Version {
  date: string;
  content: string;
}

interface Props {
  title: string;
  date: string;
  updated: string;
  backlinks: Backlink[];
  versions?: Version[];
}

const { title, date, updated, backlinks } = Astro.props;
---

<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{title} - at an arbor</title>
    <meta name="description" content={title} />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={title} />
    <meta property="og:type" content="article" />
    <meta property="og:url" content={`https://0xsalome.github.io/at-an-arbor/blog/${Astro.params.slug}`} />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Shippori+Mincho:wght@400;700&family=Noto+Serif+JP:wght@400;700&family=JetBrains+Mono&display=swap" rel="stylesheet">
    <script is:inline>
      (function() {
        const isDark = localStorage.getItem('darkMode') === 'true';
        if (isDark) document.documentElement.classList.add('dark');
      })();
    </script>
    <style>
      /* Prose„Çπ„Çø„Ç§„É´ÔºàTailwind Typography‰∫íÊèõÔºâ */
      .prose {
        color: #374151;
        max-width: 65ch;
      }
      .prose :where(p):not(:where([class~="not-prose"] *)) {
        margin-top: 1.25em;
        margin-bottom: 1.25em;
      }
      .prose :where(a):not(:where([class~="not-prose"] *)) {
        color: #2563eb;
        text-decoration: underline;
        font-weight: 500;
      }
      .prose :where(strong):not(:where([class~="not-prose"] *)) {
        color: #111827;
        font-weight: 600;
      }
      .prose :where(h1):not(:where([class~="not-prose"] *)) {
        color: #111827;
        font-weight: 800;
        font-size: 2.25em;
        margin-top: 0;
        margin-bottom: 0.8888889em;
        line-height: 1.1111111;
      }
      .prose :where(h2):not(:where([class~="not-prose"] *)) {
        color: #111827;
        font-weight: 700;
        font-size: 1.5em;
        margin-top: 2em;
        margin-bottom: 1em;
        line-height: 1.3333333;
      }
      .prose :where(code):not(:where([class~="not-prose"] *)) {
        color: #111827;
        font-weight: 600;
        font-size: 0.875em;
      }
      .prose :where(pre):not(:where([class~="not-prose"] *)) {
        color: #e5e7eb;
        background-color: #1f2937;
        overflow-x: auto;
        font-weight: 400;
        font-size: 0.875em;
        line-height: 1.7142857;
        margin-top: 1.7142857em;
        margin-bottom: 1.7142857em;
        border-radius: 0.375rem;
        padding: 0.8571429em 1.1428571em;
      }
      :global(.dark) .prose {
        color: #d1d5db;
      }
      :global(.dark) .prose :where(a):not(:where([class~="not-prose"] *)) {
        color: #60a5fa;
      }
      :global(.dark) .prose :where(strong):not(:where([class~="not-prose"] *)) {
        color: #f9fafb;
      }
      :global(.dark) .prose :where(h1):not(:where([class~="not-prose"] *)),
      :global(.dark) .prose :where(h2):not(:where([class~="not-prose"] *)) {
        color: #f9fafb;
      }
    </style>
  </head>
  <body class="min-h-screen bg-paper-white dark:bg-ink-black text-text-main dark:text-text-inv transition-colors">
    <div class="flex flex-col md:flex-row">
      <!-- Sidebar -->
      <aside class="w-full md:w-1/6 p-6 md:p-12 border-b md:border-b-0 md:border-r border-gray-200 dark:border-gray-700">
        <nav class="space-y-6">
          <a href="/at-an-arbor/" class="block text-sm font-mono text-purple-600 dark:text-purple-300 hover:text-purple-700 dark:hover:text-purple-200 transition-colors">‚Üê HOME</a>
          <div class="text-xs font-mono text-gray-500 dark:text-gray-400">
            at an arbor
          </div>
        </nav>
      </aside>

      <!-- Main content -->
      <main class="w-full md:w-5/6 p-6 md:p-16 lg:p-24 max-w-4xl mx-auto">
        <header class="mb-12 border-b border-gray-900 dark:border-gray-600 pb-8">
          <div class="font-mono text-sm text-gray-500 dark:text-gray-400 mb-4">
            {updated}
            {updated !== date && <span> (Published: {date})</span>}
            <span class="mx-2">/</span>
            BLOG
            {updated !== date && <span> / ·öõ Regrown</span>}
          </div>
          <h1 class="text-3xl md:text-5xl font-serif font-bold leading-tight">{title}</h1>
        </header>

        <article class="prose prose-stone dark:prose-invert prose-lg font-serif leading-loose">
          <slot />
        </article>

        {Astro.props.versions && Astro.props.versions.length > 0 && (
          <>
            <hr class="my-8 border-gray-300 dark:border-gray-700" />

            <section class="past-versions">
              <details>
                <summary class="cursor-pointer text-sm font-mono text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-200 transition-colors">
                  üìú Past Versions ({Astro.props.versions.length})
                </summary>

                <div class="mt-6 space-y-8">
                  {Astro.props.versions.map((version: Version) => (
                    <div class="version border-l-2 border-gray-300 dark:border-gray-700 pl-6">
                      <h3 class="text-sm font-mono text-gray-500 dark:text-gray-400 mb-4">
                        {version.date}
                        {version.date === date && ' (Original)'}
                      </h3>
                      <div
                        class="prose prose-stone dark:prose-invert prose-sm"
                        set:html={marked(version.content)}
                      />
                    </div>
                  ))}
                </div>
              </details>
            </section>
          </>
        )}

        {backlinks.length > 0 && (
          <section class="mt-12 pt-8 border-t border-gray-200 dark:border-gray-700">
            <h2 class="text-sm font-mono text-gray-500 dark:text-gray-400 mb-4 tracking-wider">
              üìé REFERENCED BY
            </h2>
            <ul class="space-y-3">
              {backlinks.map((link) => (
                <li>
                  <a
                    href={`/at-an-arbor/blog/${link.slug}`}
                    class="text-purple-600 dark:text-purple-300 hover:text-purple-700 dark:hover:text-purple-200 transition-colors font-serif text-lg"
                  >
                    {link.title}
                  </a>
                  <span class="text-sm text-gray-500 dark:text-gray-400 ml-2">({link.updated})</span>
                </li>
              ))}
            </ul>
          </section>
        )}

        <footer class="mt-16 pt-8 border-t border-gray-200 dark:border-gray-700 flex justify-between font-mono text-sm">
          <a href="/at-an-arbor/" class="text-purple-600 dark:text-purple-300 hover:text-purple-700 dark:hover:text-purple-200 transition-colors">‚Üê BACK</a>
          <span class="text-gray-500 dark:text-gray-400">END OF RECORD</span>
        </footer>
      </main>
    </div>
  </body>
</html>
